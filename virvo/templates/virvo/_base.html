  {% load staticfiles %}<!DOCTYPE html>
<html>
  <head>
    <title>{% block title %}Test layout{% endblock %}</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    
    
    
    <link rel="stylesheet" type="text/css" href="{% static 'dma/css/bootstrap.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'dma/css/font-awesome.min.css' %}">
    <link rel="stylesheet" href="{% static 'gis/assets/css/ol.css' %}" type = "text/css"/>
    <link rel="stylesheet" href="{% static 'gis/assets/css/jquery-ui.css' %}" type = "text/css"/>

     <!-- virvo provider -->
    <link href="{% static 'virvo/data/styles.css' %}" type="text/css" rel="stylesheet"/>
    <link href="{% static 'virvo/state_content.css' %}" type="text/css" rel="stylesheet"/>

    <link href="{% static 'virvo/grid.css' %}" type="text/css" rel="stylesheet"/>

    <!-- openlayer -->
    
    <script src="{%  static 'gis/assets/js/ol-debug.js' %} "></script>

    <script src="{%  static 'gis/assets/js/jquery.js' %} "></script>
    <script src="{%  static 'gis/assets/js/jquery-ui.js' %} "></script>
    <script src="{% static 'dma/js/bootstrap.min.js' %}"></script>

    <!-- zTree -->
    <link rel="stylesheet" href="{% static 'zTree/css/demo.css' %}" type="text/css">
    <link rel="stylesheet" href="{% static 'zTree/css/zTreeStyle/zTreeStyle.css' %}" type="text/css">
  
    <script type="text/javascript" src="{% static 'zTree/js/jquery.ztree.core.js' %}"></script>

    <!-- echart -->
    <script src="{% static 'virvo/echarts.min.js' %}"></script>

    <!-- jQuery Modal -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" />
 -->
    {% block stylesheet %}
    <style type="text/css">
    </style>
    {% endblock %}
</head>
<body>
    <div class="wrapper">

      <!-- header -->
      {% include 'virvo/_header.html' %}

      <!-- nav menu -->
      {% include 'virvo/_nav.html' %}

      <div class=" content">
        <!-- breadcrumbs -->
        <div class="breads center">
          <div class="bred_text ">{% block breadcrumbs %}<a href="#"><span class="fa fa-home">首页</span></a> / 站点管理{% endblock %}</div>
        </div>
          <!-- page title -->
        <div class="page_title center">
          <div class="pg_text"><span>{% block page_title %}站点管理{% endblock %}</span></div>
        </div>
        
        <!-- main contents -->
        <div class="main_content">

          {% block organizationtree %}
          <div class=" treel">
            {% include 'virvo/ogantree.html' %}
          </div>
          {% endblock %}

          {% block content %}
          <div class=" context">
              

              
          </div>
          {% endblock %}
          
        </div>
        
      </div>
      
    </div>
    {% block javascript %}
    <SCRIPT LANGUAGE="JavaScript">

    $(function(){
        loadTree();
    });

    function slotSelectChanged()
    {
      var zTree = $.fn.zTree.getZTreeObj("treeDemo");
      
      var nodes = zTree.getSelectedNodes();
      if (nodes.length) {
        var n = nodes[0]
        console.log(n.name)

        $.ajax({
            type:"GET",
            // url:"/virvo/gettreenode/" , 
            url:"/virvo/dma/" + n.id,
            dataType: "html",
            
            
            success:function(res){
                 
                // $("#collapse1").html(res)
                
                $('#myModal').on('shown.bs.modal', function () {
                    load_station_map();
                 })
            },
            error:function(res){
              console.log("error?")
              console.log(res);
            }
        });

      }
      
    }


    function loadTree()
    {
       var _this = this;
       // zTree 的参数配置，深入使用请参考 API 文档（setting 配置详解）
       var setting = {
          view: {
            fontCss: getFont,
            nameIsHTML: true,
            addDiyDom: addDiyDom
          },
          // callback:{
          //   onClick:function(){_this.slotSelectChanged();}
          // },
          data: {
            simpleData: {
              enable: true
            }
          }
        };

        function getFont(treeId, node) {
          return node.font ? node.font : {};
        }

        var IDMark_A = "_a";

        function addDiyDom(treeId, treeNode) {
          if (treeNode.parentNode && treeNode.tid!=1) return;

          if (treeNode.name != '威尔沃') return;
          var aObj = $("#" + treeNode.tId + IDMark_A);

          console.log(treeId);
          console.log(treeNode.id);
          console.log(treeNode.name);
          //if (treeNode.id == 1) {
            var editStr = '<img id="diyBtn_add" class="img " src="/static/virvo/images/add.png" tabindex="0" onfocus="this.blur()"; style="outline: none;">';
            
            aObj.after(editStr);
            console.log(aObj);
            var btn = $("#diyBtn_add");
            if (btn) btn.bind("click", function(){
              $("#new-form-modal").modal();
            });
          //}
        }
            
        $.ajax({
            type:"POST",
            url:"/virvo/gettree/" , 
            dataType: "json",
            data:{'csrfmiddlewaretoken': '{{ csrf_token }}'},
            
            success:function(res){
                var json = res['trees']   
                console.log(json);    
                $.fn.zTree.init($("#treeDemo"), setting, json);
                var zTree = $.fn.zTree.getZTreeObj("treeDemo");
                
            }
        });
    }    
        
</SCRIPT>
    {% endblock %}
</body>
</html>